{% extends "base.html" %}

{% block title %}Continue Reading - Comic Server{% endblock %}

{% block content %}
<div class="space-y-6" x-data="continueReading()">

    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold">Continue Reading</h1>
    </div>

    <div class="flex space-x-2 border-b border-gray-700 overflow-x-auto">
        <button
            x-on:click="setFilter('in_progress')"
            :class="filter === 'in_progress' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'"
            class="px-4 py-2 border-b-2 font-medium transition-colors whitespace-nowrap"
        >
            In Progress
        </button>
        <button
            x-on:click="setFilter('recent')"
            :class="filter === 'recent' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'"
            class="px-4 py-2 border-b-2 font-medium transition-colors whitespace-nowrap"
        >
            Recently Read
        </button>
        <button
            x-on:click="setFilter('completed')"
            :class="filter === 'completed' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-300'"
            class="px-4 py-2 border-b-2 font-medium transition-colors whitespace-nowrap"
        >
            Completed
        </button>
    </div>

    <div x-show="loading" class="flex justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

    <div x-show="!loading" class="space-y-4">
        <template x-for="item in items" :key="item.comic_id">
            {% include "partials/progress_card.html" %}
        </template>
    </div>

    <div x-show="!loading && items.length === 0" class="text-center py-20 text-gray-400">
        <p class="text-lg" x-text="getEmptyMessage()"></p>
        <a :href="window.parker.route('pages.home')" class="text-blue-400 hover:underline mt-2 inline-block">Browse Library</a>
    </div>

</div>

<script>
function continueReading() {
    return {
        filter: 'in_progress',
        items: [],
        loading: true,

        init() {
            this.loadItems();
        },

        async setFilter(newFilter) {
            this.filter = newFilter;
            await this.loadItems();
        },

        async loadItems() {
            this.loading = true;
            this.items = []; // Clear to prevent flash
            try {
                // Fetch JSON from existing API
                const res = await fetch(window.parker.route('progress.recent_progress', {}, `filter=${this.filter}&limit=50`));
                if (res.ok) {
                    const data = await res.json();
                    this.items = data.results;
                }
            } catch (e) {
                console.error("Failed to load progress", e);
            } finally {
                this.loading = false;
            }
        },

        getEmptyMessage() {
            if (this.filter === 'in_progress') return 'No comics currently in progress.';
            if (this.filter === 'completed') return 'No completed comics yet.';
            return 'No reading history found.';
        },

        async markRead(comicId) {
            try {
                await fetch(window.parker.route('progress.mark_comic_as_read', { comic_id: comicId }), { method: 'POST' });
                // Refresh list to remove item or update status
                this.loadItems();
            } catch (e) { console.error(e); }
        },

        async markUnread(comicId) {
            if(!confirm("Clear reading progress for this comic?")) return;
            try {
                await fetch(window.parker.route('progress.mark_comic_as_unread', { comic_id: comicId} ), { method: 'DELETE' });
                this.loadItems();
            } catch (e) { console.error(e); }
        }
    }
}
</script>
{% endblock %}