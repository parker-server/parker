<div x-data="{
    collectionModalOpen: false,

    init() {
        // 1. Listen for 'Mark Read / Unread event'
        window.addEventListener('batch-set-read', (e) => {
            // e.detail.read contains true/false
            this.setBatchReadStatus(e.detail.read);
        });
    },

    async setBatchReadStatus(isRead) {
        const action = isRead ? 'Read' : 'Unread';
        if(!confirm(`Mark ${$store.batch.count} items as ${action}?`)) return;

        try {

            // Prepare payload
            // Access the getter once to avoid re-calculating it multiple times
            const batchPayload = $store.batch.payload;

            // Prepare payload with the boolean flag
            const payload = { ...batchPayload, read: isRead };

            // Use the typed array from the payload
            // This ensures we don't accidentally update Comic #1 when we selected Series #1
            const affectedIds = batchPayload.comic_ids;

            const res = await fetch(window.parker.route('batch.mark_read'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                window.parker.showToast(`Batch marked as ${action}!`);

                // Dispatch update event
                // This tells every card on the page to check if it needs to update
                window.dispatchEvent(new CustomEvent('comics-updated', {
                    detail: {
                        ids: affectedIds,
                        read: isRead
                    }
                }));

                $store.batch.clear();
                // window.location.reload(); // Recommended to reflect 'Unread' state immediately
            }
        } catch(e) { console.error(e); }
    }

}">
</div>