<div x-data="globalDialog()"
     x-on:keydown.window.escape="close()"
     class="relative z-[100]"
     style="display: none;"
     x-show="isOpen">

    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-on:click="close()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">

            <div class="relative transform overflow-hidden rounded-lg bg-gray-800 border border-gray-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95">

                <div class="p-6">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full sm:mx-0 sm:h-10 sm:w-10 mb-4 sm:mb-0"
                             :class="type === 'danger' ? 'bg-red-900/30' : 'bg-blue-900/30'">

                            <template x-if="type === 'danger'">
                                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </template>

                            <template x-if="type !== 'danger'">
                                <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                                </svg>
                            </template>
                        </div>

                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg font-bold leading-6 text-white" x-text="title"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-400" x-text="message"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-lg px-3 py-2 text-sm font-bold text-white shadow-sm sm:w-auto"
                            :class="type === 'danger' ? 'bg-red-600 hover:bg-red-500' : 'bg-blue-600 hover:bg-blue-500'"
                            @click="resolve(true)"
                            x-text="confirmText"
                            x-ref="confirmBtn">
                    </button>

                    <button type="button"
                            class="mt-3 inline-flex w-full justify-center rounded-lg bg-gray-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-600 sm:mt-0 sm:w-auto"
                            @click="resolve(false)"
                            x-text="cancelText"
                            x-show="showCancel">
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('globalDialog', () => ({
        isOpen: false,
        title: '',
        message: '',
        type: 'info', // 'info', 'alert', 'danger'
        confirmText: 'OK',
        cancelText: 'Cancel',
        showCancel: true,
        resolvePromise: null,

        init() {
            // Expose this component to the global window object
            window.parker = window.parker || {};
            window.parker.dialog = this;
        },

        // --- Public API ---

        // Usage: await window.parker.dialog.alert('Title', 'Message')
        alert(title, message) {
            return this.open({
                title,
                message,
                type: 'alert',
                showCancel: false,
                confirmText: 'OK'
            });
        },

        // Usage: const confirmed = await window.parker.dialog.confirm('Delete?', 'Are you sure?', { isDestructive: true })
        confirm(title, message, options = {}) {
            return this.open({
                title,
                message,
                type: options.isDestructive ? 'danger' : 'info',
                confirmText: options.confirmText || (options.isDestructive ? 'Remove' : 'Confirm'),
                cancelText: options.cancelText || 'Cancel',
                showCancel: true
            });
        },

        // --- Internal Logic ---

        open(params) {
            this.title = params.title || 'Alert';
            this.message = params.message || '';
            this.type = params.type || 'info';
            this.confirmText = params.confirmText;
            this.cancelText = params.cancelText;
            this.showCancel = params.showCancel !== false;

            this.isOpen = true;

            // Focus the confirm button for accessibility
            this.$nextTick(() => {
                if(this.$refs.confirmBtn) this.$refs.confirmBtn.focus();
            });

            // Return a Promise that resolves true (confirm) or false (cancel)
            return new Promise((resolve) => {
                this.resolvePromise = resolve;
            });
        },

        resolve(value) {
            this.isOpen = false;
            if (this.resolvePromise) {
                this.resolvePromise(value);
                this.resolvePromise = null;
            }
        },

        close() {
            this.resolve(false);
        }
    }));
});
</script>