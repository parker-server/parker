<div x-data="dynamicBackground()" class="fixed inset-0 z-0 pointer-events-none overflow-hidden bg-gray-900"
     x-show="style !== 'NONE'">

     <!-- Hero Image - adjust brightness/opacity based on mode -->
    <template x-if="['HERO', 'HYBRID'].includes(style) && imageUrl">
        <div class="absolute inset-0 bg-cover bg-center transition-opacity duration-700"
             :style="`background-image: url('${imageUrl}');
                        opacity: ${style === 'HYBRID' ? '0.4' : '0.5'};
                        filter: blur(3px) brightness(${style === 'HYBRID' ? '0.6' : '0.4'});
                        transform: scale(1.1);`">
        </div>
    </template>

    <!-- Colorscape - stronger in HYBRID mode -->
    <template x-if="['COLORSCAPE', 'HYBRID'].includes(style)">
        <div class="absolute inset-0 transition-opacity duration-700"
             :class="style === 'HYBRID' ? 'opacity-90' : 'opacity-90'"
             :style="style === 'HYBRID' ? hybridGradientStyle : gradientStyle">
        </div>
    </template>


    <div class="absolute inset-0" :style="overlayStyle"></div>
    
</div>

<script>
function dynamicBackground() {
    return {
        style: 'NONE', // NONE, HERO, COLORSCAPE, HYBRID
        primary: '#000000',
        secondary: '#1a1a1a',
        accent1: '#333333',
        accent2: '#444444',
        accent3: '#555555',
        imageUrl: '',

        async init() {

            if(!window.PAGE_CONTEXT)
            {
                this.style = 'NONE';
                return;
            }

            // 1. Fetch System Setting
            // In a real app, you might inject this via backend template to avoid a fetch
            // But fetching ensures we respect user changes immediately
            const settingRes = await fetch(window.parker.route('settings.list'));
            if(settingRes.ok) {
                const settings = await settingRes.json();
                // Find ui.background_style
                const styleSetting = settings.appearance.find(s => s.key === 'ui.background_style');
                console.log(styleSetting);
                this.style = styleSetting ? styleSetting.value : 'NONE';
            }

            // 2. Read Context from the Page
            // The parent page (comic_detail, series_detail) must expose these variables globally
            this.primary = window.PAGE_CONTEXT.colors?.primary || '#000000';
            this.secondary = window.PAGE_CONTEXT.colors?.secondary || '#1a1a1a';
            this.accent1 = window.PAGE_CONTEXT.colors?.accent1 || '#333333';
            this.accent2 = window.PAGE_CONTEXT.colors?.accent2 || '#444444';
            this.accent3 = window.PAGE_CONTEXT.colors?.accent3 || '#555555';
            this.imageUrl = window.PAGE_CONTEXT.imageUrl || '';

        },

        get gradientStyle() {
            // Pure colorscape mode - bolder colors
            return `background:
                radial-gradient(ellipse at 20% 20%, ${this.primary} 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, ${this.secondary} 0%, transparent 50%),
                radial-gradient(circle at 60% 70%, ${this.accent1} 0%, transparent 45%),
                radial-gradient(circle at 30% 80%, ${this.accent2} 0%, transparent 40%),
                radial-gradient(circle at 90% 85%, ${this.accent3} 0%, transparent 35%),
                linear-gradient(to bottom, #111827 0%, #000 100%);`;
        },

        get hybridGradientStyle() {
            // Hybrid mode - use mix-blend-mode in the style itself for better control
            return `
                background:
                    radial-gradient(ellipse at 20% 20%, ${this.primary} 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 30%, ${this.secondary} 0%, transparent 50%),
                    radial-gradient(circle at 60% 70%, ${this.accent1} 0%, transparent 45%),
                    radial-gradient(circle at 30% 80%, ${this.accent2} 0%, transparent 40%),
                    radial-gradient(circle at 90% 85%, ${this.accent3} 0%, transparent 35%),
                    linear-gradient(to bottom, #111827 0%, #000 100%);
                mix-blend-mode: screen;
            `;
        },

        get overlayStyle() {
            // Stronger overlay in HYBRID mode for better text readability
            if (this.style === 'HYBRID') {
                return `background: linear-gradient(to bottom,
                    rgba(17, 24, 39, 0.5) 0%,
                    rgba(17, 24, 39, 0.65) 50%,
                    rgba(17, 24, 39, 0.80) 100%);`;
            }

            // Lighter overlay for HERO and COLORSCAPE
            return `background: linear-gradient(to bottom,
                rgba(17, 24, 39, 0.3) 0%,
                rgba(17, 24, 39, 0.5) 50%,
                rgba(17, 24, 39, 0.7) 100%);`;
        }


    }
}
</script>