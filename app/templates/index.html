{% extends "base.html" %}

{% block title %}Home - Comic Server{% endblock %}

{% block content %}
<div class="space-y-12" x-data="homePage()">

    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Library</h1>
            <p class="text-gray-400 mt-1">Welcome back. Here's what's new in your collection.</p>
        </div>
        </div>

    <div x-show="!loading.libraries">
        <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Your Libraries</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <template x-for="lib in libraries" :key="lib.id">
                {% include "partials/library_card.html" %}
            </template>

            <div x-show="libraries.length === 0" class="col-span-full py-8 text-center text-gray-500 bg-gray-800/50 rounded-lg border border-dashed border-gray-700">
                No libraries found. <span class="text-gray-400">Ask an admin to assign you access.</span>
            </div>
        </div>
    </div>

    <div x-show="!loading.recent && recentSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white">Recently Added</h2>
            <a href="/search?sort_by=created&sort_order=desc" class="text-sm text-blue-400 hover:text-white transition-colors">View All</a>
        </div>

        <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="series in recentSeries" :key="series.id">
                {% include "partials/series_card.html" %}
            </template>
        </div>
    </div>

    <div x-show="!loading.updated && updatedSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white">Recently Updated</h2>
            <a href="/search?sort_by=year&sort_order=desc" class="text-sm text-blue-400 hover:text-white transition-colors">View All</a>
        </div>

        <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="series in updatedSeries" :key="series.id">
                {% include "partials/series_card.html" %}
            </template>
        </div>
    </div>

    <div x-show="isLoading" class="flex justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

</div>

<script>
function homePage() {
    return {
        libraries: [],
        recentSeries: [],
        updatedSeries: [],

        loading: {
            libraries: true,
            recent: true,
            updated: true
        },

        get isLoading() {
            return this.loading.libraries || this.loading.recent || this.loading.updated;
        },

        init() {
            this.fetchLibraries();
            this.fetchRecent();
            this.fetchUpdated();
        },

        async fetchLibraries() {
            try {
                const res = await fetch('/api/libraries/');
                if (res.ok) this.libraries = await res.json();
            } catch(e) { console.error(e); }
            finally { this.loading.libraries = false; }
        },

        async fetchRecent() {
            try {
                // Fetch top 10 created descending
                const res = await fetch('/api/series/?sort_by=created&sort_desc=true&size=10');
                if (res.ok) {
                    const data = await res.json();
                    this.recentSeries = data.items;
                }
            } catch(e) { console.error(e); }
            finally { this.loading.recent = false; }
        },

        async fetchUpdated() {
            try {
                // Fetch top 10 updated descending
                const res = await fetch('/api/series/?sort_by=updated&sort_desc=true&size=10');
                if (res.ok) {
                    const data = await res.json();
                    this.updatedSeries = data.items;
                }
            } catch(e) { console.error(e); }
            finally { this.loading.updated = false; }
        }
    }
}
</script>

<style>
/* Custom Scrollbar for horizontal lists */
.scrollbar-thin::-webkit-scrollbar {
    height: 8px;
}
.scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: #374151;
    border-radius: 4px;
}
.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background-color: #4b5563;
}
</style>
{% endblock %}