{% extends "base.html" %}

{% block title %}Home - Comic Server{% endblock %}

{% block content %}
<div class="space-y-12" x-data="homePage()">

    <div x-show="!loading.resume && resumeComics.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span>ðŸ“–</span> Jump Back In
            </h2>
        </div>

        <div class="flex space-x-4 overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="comic in resumeComics" :key="comic.id">
                <div class="w-40 flex-shrink-0">
                    {% include "partials/comic_card.html" %}
                </div>
            </template>
        </div>
    </div>

    <div x-show="!loading.onDeck && onDeckSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span>â–¶</span> Up Next
            </h2>
        </div>
        <div class="flex space-x-4 overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="comic in onDeckSeries" :key="comic.id">
                <div class="w-40 flex-shrink-0">
                    {% include "partials/comic_card.html" %}
                </div>
            </template>
        </div>
    </div>


    <div x-show="!loading.topRated && topRatedComics.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-yellow-400">â˜…</span> Critically Acclaimed
            </h2>
        </div>

        <div class="flex space-x-4 overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="comic in topRatedComics" :key="comic.id">
                <div class="w-36 flex-shrink-0">
                    {% include "partials/comic_card.html" %}
                </div>
            </template>
        </div>
    </div>

    <div x-show="!loading.random && randomComics.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span>ðŸŽ²</span> Random Gems
            </h2>
            <button @click="fetchRandom()" class="text-xs text-blue-400 hover:text-white">Spin Again â†»</button>
        </div>

        <div class="flex space-x-4 overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="comic in randomComics" :key="comic.id">
                <div class="w-36 flex-shrink-0">
                    {% include "partials/comic_card.html" %}
                </div>
            </template>
        </div>
    </div>


    <div x-show="!loading.starred && starredSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-yellow-400">â˜…</span> Want to Read
            </h2>
            </div>

        <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="series in starredSeries" :key="series.id">
                {% include "partials/series_card.html" %}
            </template>
        </div>
    </div>


    <div x-show="!loading.recent && recentSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white">Recently Added</h2>
            <a href="/search?sort_by=created&sort_order=desc" class="text-sm text-blue-400 hover:text-white transition-colors">View All</a>
        </div>

        <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="series in recentSeries" :key="series.id">
                {% include "partials/series_card.html" %}
            </template>
        </div>
    </div>

    <div x-show="!loading.updated && updatedSeries.length > 0">
        <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-white">Recently Updated</h2>
            <a href="/search?sort_by=updated&sort_order=desc" class="text-sm text-blue-400 hover:text-white transition-colors">View All</a>
        </div>

        <div class="flex space-x-6 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
            <template x-for="series in updatedSeries" :key="series.id">
                {% include "partials/series_card.html" %}
            </template>
        </div>
    </div>

    <div x-show="isLoading" class="flex justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

</div>

<script>
function homePage() {
    return {
        recentSeries: [],
        updatedSeries: [],
        starredSeries: [],
        onDeckSeries: [],
        randomComics: [],
        topRatedComics: [],
        resumeComics: [],

        loading: {
            recent: true,
            updated: true,
            starred: true,
            onDeck: true,
            random: true,
            topRated: true,
            resume: true
        },

        get isLoading() {
            return this.loading.recent
                || this.loading.updated || this.loading.starred
                || this.loading.onDeck || this.loading.random
                || this.loading.topRated || this.loading.resume
                ;
        },

        init() {
            this.fetchStarred();
            this.fetchRecent();
            this.fetchUpdated();
            this.fetchOnDeck();
            this.fetchResume();
            this.fetchRandom();
            this.fetchTopRated();

        },

        async fetchStarred() {
            try {
                // Fetch starred series sorted by updated (recently modified or starred)
                const res = await fetch(window.url('/api/series/?only_starred=true&size=20'));
                if (res.ok) {
                    const data = await res.json();
                    this.starredSeries = data.items;
                }
            } catch(e) { console.error(e); }
            finally { this.loading.starred = false; }
        },

        async fetchRecent() {
            try {
                // Fetch top 10 created descending
                const res = await fetch(window.url('/api/series/?sort_by=created&sort_desc=true&size=10'));
                if (res.ok) {
                    const data = await res.json();
                    this.recentSeries = data.items;
                }
            } catch(e) { console.error(e); }
            finally { this.loading.recent = false; }
        },

        async fetchUpdated() {
            try {
                // Fetch top 10 updated descending
                const res = await fetch(window.url('/api/series/?sort_by=updated&sort_desc=true&size=10'));
                if (res.ok) {
                    const data = await res.json();
                    this.updatedSeries = data.items;
                }
            } catch(e) { console.error(e); }
            finally { this.loading.updated = false; }
        },

        async fetchOnDeck() {
            try {
                const res = await fetch(window.url('/api/home/up-next'));
                if (res.ok) {
                    this.onDeckSeries = await res.json();
                }
            } catch(e) { console.error(e); }
            finally { this.loading.onDeck = false; }
        },

        async fetchResume() {
            try {
                const res = await fetch(window.url('/api/home/resume'));
                if (res.ok) this.resumeComics = await res.json();
            } catch(e) { console.error(e); }
            finally { this.loading.resume = false; }
        },

        async fetchRandom() {
            try {
                const res = await fetch(window.url('/api/home/random?limit=12'));
                if (res.ok) this.randomComics = await res.json();
            } catch(e) { console.error(e); }
            finally { this.loading.random = false; }
        },

        async fetchTopRated() {
            try {
                const res = await fetch(window.url('/api/home/rated?limit=12'));
                if (res.ok) this.topRatedComics = await res.json();
            } catch(e) { console.error(e); }
            finally { this.loading.topRated = false; }
        }

    }
}
</script>

<style>
/* Custom Scrollbar for horizontal lists */
.scrollbar-thin::-webkit-scrollbar {
    height: 8px;
}
.scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: #374151;
    border-radius: 4px;
}
.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background-color: #4b5563;
}
</style>
{% endblock %}