{% extends "base.html" %}

{% block title %}Advanced Search - Comic Server{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto" x-data="searchBuilder()">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Advanced Search</h1>
    </div>

    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl">

        <div class="flex items-center space-x-4 mb-6 border-b border-gray-700 pb-4">
            <span class="text-gray-400">Match</span>
            <select x-model="match" class="bg-gray-700 text-white rounded px-3 py-1 border border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none">
                <option value="all">All Rules (AND)</option>
                <option value="any">Any Rule (OR)</option>
            </select>
            <span class="text-gray-400">of the following:</span>
        </div>

        <div class="space-y-4">
            <template x-for="(rule, index) in rules" :key="rule.id">
                <div class="flex flex-col md:flex-row gap-3 items-start md:items-center bg-gray-900/50 p-3 rounded-lg border border-gray-700/50">

                    <select x-model="rule.field" @change="resetRule(rule)" class="w-full md:w-48 bg-gray-700 text-white rounded px-3 py-2 border border-gray-600 outline-none">
                        <optgroup label="Metadata">
                            <option value="series">Series Name</option>
                            <option value="title">Issue Title</option>
                            <option value="publisher">Publisher</option>
                            <option value="year">Release Year</option>
                            <option value="format">Format</option>
                            <option value="imprint">Imprint</option>
                        </optgroup>
                        <optgroup label="Creators">
                            <option value="writer">Writer</option>
                            <option value="penciller">Penciller</option>
                            <option value="inker">Inker</option>
                            <option value="colorist">Colorist</option>
                            <option value="editor">Editor</option>
                        </optgroup>
                        <optgroup label="Tags">
                            <option value="character">Character</option>
                            <option value="team">Team</option>
                            <option value="location">Location</option>
                        </optgroup>
                        <optgroup label="Organization">
                            <option value="library">Library</option>
                            <option value="collection">Collection</option>
                            <option value="reading_list">Reading List</option>
                        </optgroup>
                    </select>

                    <select x-model="rule.operator" class="w-full md:w-40 bg-gray-700 text-white rounded px-3 py-2 border border-gray-600 outline-none">
                        <option value="equal">Equals</option>
                        <option value="not_equal">Not Equals</option>
                        <option value="contains">Contains (Any)</option>
                        <option value="does_not_contain">Does Not Contain</option>
                        <option value="must_contain">Must Contain (All)</option>
                        <option value="is_empty">Is Empty</option>
                        <option value="is_not_empty">Is Not Empty</option>
                    </select>

                    <div class="flex-1 w-full" x-show="!['is_empty', 'is_not_empty'].includes(rule.operator)">

                        <div x-show="['title', 'year'].includes(rule.field)">
                            <input type="text" x-model="rule.value" class="w-full bg-gray-700 text-white rounded px-3 py-2 border border-gray-600 outline-none focus:border-blue-500">
                        </div>

                        <div x-show="!['title', 'year'].includes(rule.field)">
                            <div
                                x-data="tagInput(rule)"
                                class="relative w-full"
                            >
                                <div class="bg-gray-700 border border-gray-600 rounded p-1 flex flex-wrap gap-2 min-h-[42px]">
                                    <template x-for="(tag, i) in tags" :key="i">
                                        <span class="bg-blue-600 text-white text-sm px-2 py-0.5 rounded flex items-center">
                                            <span x-text="tag"></span>
                                            <button @click="removeTag(i)" class="ml-1 hover:text-red-300 font-bold">×</button>
                                        </span>
                                    </template>

                                    <input
                                        type="text"
                                        x-model="input"
                                        @input.debounce.300ms="fetchSuggestions()"
                                        @keydown.enter.prevent="addTag()"
                                        @keydown.backspace="handleBackspace()"
                                        class="bg-transparent border-none focus:ring-0 text-white flex-1 min-w-[120px] outline-none h-8 px-1"
                                        placeholder="Type to find..."
                                    >
                                </div>

                                <div x-show="suggestions.length > 0" @click.away="suggestions = []" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded mt-1 shadow-lg max-h-60 overflow-y-auto">
                                    <template x-for="sugg in suggestions" :key="sugg">
                                        <div
                                            @click="selectSuggestion(sugg)"
                                            class="px-3 py-2 hover:bg-blue-600 cursor-pointer text-white border-b border-gray-600 last:border-0"
                                            x-text="sugg"
                                        ></div>
                                    </template>
                                </div>
                            </div>
                        </div>

                    </div>

                    <button @click="removeRule(index)" class="text-red-400 hover:text-red-300 p-2 hover:bg-red-900/30 rounded" title="Remove Rule">
                        ✕
                    </button>
                </div>
            </template>
        </div>

        <div class="mt-4">
            <button @click="addRule()" class="text-blue-400 hover:text-blue-300 font-bold flex items-center px-3 py-2 hover:bg-gray-700 rounded transition-colors">
                <span class="text-xl mr-2">+</span> Add Rule
            </button>
        </div>

        <div class="border-t border-gray-700 my-6"></div>

        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-400 text-sm">Sort By</span>
                    <select x-model="sortBy" class="bg-gray-700 text-white rounded px-2 py-1 text-sm border border-gray-600 outline-none">
                        <option value="created">Date Added</option>
                        <option value="year">Release Year</option>
                        <option value="series">Series Name</option>
                        <option value="title">Issue Title</option>
                        <option value="page_count">Page Count</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-400 text-sm">Limit</span>
                    <input type="number" x-model="limit" class="w-20 bg-gray-700 text-white rounded px-2 py-1 text-sm border border-gray-600 outline-none text-center">
                </div>
            </div>

            <button @click="performSearch()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-8 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-colors">
                <span x-show="loading" class="animate-spin">↻</span>
                <span>Search Comics</span>
            </button>
        </div>
    </div>

    <div class="mt-8" x-show="hasSearched" style="display: none;">
        <h2 class="text-xl font-bold mb-4 flex items-center text-white">
            Results
            <span class="ml-3 text-sm font-normal text-gray-300 bg-gray-800 px-3 py-1 rounded-full border border-gray-700" x-text="`${totalResults} found`"></span>
        </h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
             <template x-for="comic in results" :key="comic.id">
                {% include "partials/comic_card.html" %}
             </template>
        </div>

        <div x-show="!loading && results.length === 0" class="text-center py-20 bg-gray-800/50 rounded-xl border border-dashed border-gray-700">
            <p class="text-gray-400 text-lg">No comics found matching your criteria.</p>
            <button @click="rules=[{id:1, field:'series', operator:'contains', value:[]}]" class="mt-4 text-blue-400 hover:underline">Reset Filters</button>
        </div>
    </div>

</div>

<script>
document.addEventListener('alpine:init', () => {

    // 1. Tag Input Component (Reusable for each row)
    Alpine.data('tagInput', (rule) => ({
        input: '',
        tags: [], // Local array to hold badges
        suggestions: [],

        init() {
            // If rule has value loaded from save, populate tags
            // Ensure we handle both single value (string/int) and array
            if (rule.value) {
                this.tags = Array.isArray(rule.value) ? rule.value : [rule.value];
            }
        },

        async fetchSuggestions() {
            if (this.input.length < 2) {
                this.suggestions = [];
                return;
            }
            try {
                // Call our new API
                const res = await fetch(`/api/search/suggestions?field=${rule.field}&query=${this.input}`);
                this.suggestions = await res.json();
            } catch(e) { console.error(e); }
        },

        addTag() {
            if (this.input.trim()) {
                this.tags.push(this.input.trim());
                this.updateRuleValue();
                this.input = '';
                this.suggestions = [];
            }
        },

        selectSuggestion(val) {
            this.tags.push(val);
            this.updateRuleValue();
            this.input = '';
            this.suggestions = [];
        },

        removeTag(index) {
            this.tags.splice(index, 1);
            this.updateRuleValue();
        },

        handleBackspace() {
            if (this.input === '' && this.tags.length > 0) {
                this.tags.pop();
                this.updateRuleValue();
            }
        },

        updateRuleValue() {
            // Update the parent rule object
            rule.value = this.tags;
        }
    }));

    // 2. Main Search Builder Logic
    Alpine.data('searchBuilder', () => ({
        rules: [
            { id: 1, field: 'series', operator: 'contains', value: [] }
        ],
        match: 'all',
        limit: 50,
        sortBy: 'created',
        results: [],
        totalResults: 0,
        loading: false,
        hasSearched: false,
        nextId: 2,

        init() {
            this.checkUrlParams();
        },

        checkUrlParams() {
            const params = new URLSearchParams(window.location.search);

            // Check if we have the minimum required params
            if (params.has('field') && params.has('value')) {
                const field = params.get('field');
                const value = params.get('value');
                // Default to 'contains' if not specified
                const operator = params.get('operator') || 'contains';

                // Overwrite the default rule with the URL rule
                this.rules = [{
                    id: 1,
                    field: field,
                    operator: operator,
                    // TagInput expects an array
                    value: [value]
                }];

                // Auto-execute the search
                // Use $nextTick to ensure the DOM/Alpine data is ready
                this.$nextTick(() => {
                    this.performSearch();
                });
            }
        },

        addRule() {
            this.rules.push({ id: this.nextId++, field: 'character', operator: 'contains', value: [] });
        },

        removeRule(index) {
            // Don't remove the last rule, just reset it
            if (this.rules.length === 1) {
                this.rules[0].value = [];
                return;
            }
            this.rules.splice(index, 1);
        },

        resetRule(rule) {
            rule.value = []; // Clear values when field changes
        },

        async performSearch() {
            this.loading = true;
            this.hasSearched = true;
            this.results = []; // Clear previous results while loading

            // Prepare payload
            const payload = {
                match: this.match,
                filters: this.rules.map(r => ({
                    field: r.field,
                    operator: r.operator,
                    // If the user typed nothing in a text box, send null to be safe,
                    // but for tags (arrays), send the array.
                    value: (Array.isArray(r.value) && r.value.length === 0) ? null : r.value
                })).filter(r => r.operator === 'is_empty' || r.operator === 'is_not_empty' || r.value !== null), // Filter out incomplete rules

                sort_by: this.sortBy,
                limit: parseInt(this.limit)
            };

            try {
                const res = await fetch('/api/comics/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Search failed");

                const data = await res.json();
                this.results = data.results;
                this.totalResults = data.total;
            } catch(e) {
                console.error("Search failed", e);
            } finally {
                this.loading = false;
            }
        }
    }));
});
</script>
{% endblock %}